<% unless @course_filter.nil? %>
<div class="ncce-aside ncce-aside--filters" data-action="resize@window->course-filter#openFilterFormOnDesktop" data-course-filter-target="filterFormHeader">
  <div class="ncce-aside--filters-header">
    <h2 class="govuk-body-m ncce-aside__title ncce-aside--filters__title">Filter courses</h2>
    <button type="button" class="ncce-courses__filter-form-toggle" data-course-filter-target="filterFormToggle" data-action="click->course-filter#toggleFilterForm">
      <span class="ncce-courses__filter-form-toggle-applied <%= filter_count(@course_filter) == 0 ? 'hidden' : '' %>" data-course-filter-target="filterCount"><%= applied_filters_string(@course_filter) %> applied</span>
      Filter courses
    </button>
  </div>
  <div class="ncce-courses__filter hidden" id="course-filter" data-course-filter-target="filterForm">
    <div class='ncce-courses__clear-filters <%= filter_count(@course_filter) == 0 ? 'hidden' : '' %>' data-course-filter-target="clearFilters">
      <%= link_to 'Clear all filters', courses_path(hub_id: @filter_params[:hub_id], anchor: 'results-top'), class: 'govuk-button button button--small govuk-body-m', data: { action: 'click->course-filter#clearFilters' } %>
    </div>
    <%= form_with url: course_filter_path, method: :get, class: 'ncce-courses__filter-form', data: { action: "ajax:success->course-filter#handleResults", 'course-filter-target': "form" } do %>
      <%= label_tag :level, 'Key Stage:', class: 'govuk-body-s ncce-label--s' %>
      <%= select_tag :level,
        options_for_select(@course_filter.age_groups.keys, @course_filter.current_level),
        {
          include_blank: 'Any level',
          class: ['govuk-select', 'ncce-select', 'ncce-select--filters', { 'filter--active' => @course_filter.current_level }],
          'aria-label': 'Filter by level',
          data: { action: "input->course-filter#filter input->course-filter#toggleActiveSelect" }
        }
      %>
      <%= label_tag :level, 'Topic:', class: 'govuk-body-s ncce-label--s' %>
      <%= select_tag :topic,
        options_for_select(@course_filter.course_tags.keys, @course_filter.current_topic),
        {
          include_blank: 'Any topic',
          class: ['govuk-select', 'ncce-select', 'ncce-select--filters', { 'filter--active' => @course_filter.current_topic }],
          'aria-label': 'Filter by topic',
          data: { action: "input->course-filter#filter input->course-filter#toggleActiveSelect" }
        }
      %>
      <%= label_tag :certificate, 'Certificate:', class: 'govuk-body-s ncce-label--s' %>
      <%= select_tag :certificate,
        options_for_select(@course_filter.certificates, @course_filter.current_certificate),
        {
          include_blank: 'Any certificate',
          class: ['govuk-select', 'ncce-select', 'ncce-select--filters', { 'filter--active' => @course_filter.current_certificate }],
          'aria-label': 'Filter by certificate',
          data: { action: "input->course-filter#filter input->course-filter#toggleActiveSelect" }
        }
      %>
      <%= label_tag :format, 'Course format:', class: 'govuk-body-s ncce-label--s' %>
      <div class="govuk-checkboxes">
      <% @course_filter.course_formats.each_with_index do |course_format, index| %>
        <div class='govuk-checkboxes__item ncce-checkboxes__item'>
          <%= check_box_tag 'course_format[]', course_format, @course_filter&.current_format&.include?(course_format.to_s), class: 'govuk-checkboxes__input ncce-checkboxes__input', data: { action: 'input->course-filter#filter  input->course-filter#toggleActiveCheckbox', 'aria-label': 'Filter by format' }, id: "course_format_#{index}" %>
          <%= label_tag "course_format_#{index}", (course_format.to_s).humanize, class: 'govuk-label govuk-checkboxes__label ncce-label ncce-checkboxes__label' %>
        </div>
      <% end %>
      </div>
      <div>
        <%= label_tag :format, 'Find a face to face course near you:', class: 'govuk-body-s ncce-label--s' %>
        <%= text_field_tag :location, @course_filter.current_location, class: 'govuk-input', placeholder: 'Postcode or Town/City' %>
        <%= submit_tag 'Search location', class: 'govuk-button button', data: { action: "click->course-filter#filter click->course-filter#addLocationFilter" } %>
      </div>
      <div class="hidden govuk-body-s" data-course-filter-target="distanceFilter">
        <%# label_tag :radius, 'Within:', class: 'govuk-body-s ncce-label--s' %>
        <span>Within</span>
        <%= select_tag :radius,
          options_for_select(@course_filter.search_radii.map { |r| ["#{r} miles", r]}, @course_filter.current_radius),
          {
            class: ['govuk-select', 'ncce-select', 'ncce-select--filters', 'ncce-aside--filters-narrow-select', { 'filter--active' => @course_filter.current_radius }],
            'aria-label': 'Filter by distance',
            data: { action: "input->course-filter#filter", course_filter_target: "radiusSelect"}
          }
        %>
        <span>of <span data-course-filter-target="geocodedLocation">search location</span> </span>
      </div>
      <div class="hidden govuk-body-s" data-course-filter-target="geocodingError">
        <p>
          This location was not recognised. Please check if it is correct.
        </p>
      </div>
      <%= hidden_field_tag 'hub_id', @course_filter.current_hub %>
      <%= hidden_field_tag 'js_enabled', false %>

      <%= submit_tag "Apply filters", :name => nil, class: 'govuk-button button ncce-courses__filter-button ncce-courses__apply-filters-button' %>
    <% end %>
    <button type="button" class="govuk-button button ncce-courses__view-results" data-action="click->course-filter#closeFilterForm" data-course-filter-target="viewResultsCount">View <%= pluralize(@course_filter.total_results_count, 'result') %></button>
  </div>
</div>
<div class="sticky ncce-aside--filters__sticky">
  <%= link_to 'back to filter', '', class: ['ncce-link'], data: { action: "click->course-filter#scrollToFilters" } %>
</div>
<% end %>
