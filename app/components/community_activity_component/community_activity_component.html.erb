<div
  class="community-activity-component <%= @class_name %>"
  data-controller="community-activity-component"
  data-community-activity-component-create-path-value="<%= achievements_path %>"
  data-community-activity-component-update-path-value="<%= achievement_path(@achievement) if @achievement %>"
  data-community-activity-component-achievements-submit-path-value="<%= submit_achievements_path %>"
  data-community-activity-component-achievement-id-value="<%= @achievement&.id %>"
  data-community-activity-component-activity-id-value="<%= @activity.id %>"
>
  <% if achievement_rejected? %>
    <div class="community-activity-component__rejected">
    <i class="icon-feedback"></i>
      <span class="community-activity-component__rejected-text govuk-body-s">
        Please provide more evidence to this activity for review.
      </span>
    </div>
  <% end %>

  <div class="community-activity-component__content">

    <span class="community-activity-component__objective">
      <span class="community-activity-component__objective-text">
        <span><%= @activity.title %></span>
      </span>
      <% if achievement_complete? %>
        <span class="community_activity_component__completed_badge_container" >
          <span class='community-activity-component__completed-badge'><%= t('.complete') %></span>
        </span>
      <% elsif @activity.coming_soon? %>
        <%= button_to t('.coming_soon'),
          '#',
          class: 'govuk-button button community-activity-component__objective-button button--full-width',
          disabled: true
        %>
      <% elsif @activity.booking_programme_slug.present? %>
        <%= link_to t('.book_button_text'),
          courses_path(certificate: @activity.booking_programme_slug),
          class: 'govuk-button button community-activity-component__objective-button',
          data: tracking_data('Book a course')
        %>
      <% elsif @activity.self_verification_info.blank? %>
        <div class="community-activity-component__objective-button-container">
          <button class="govuk-button button" data-action="click->community-activity-component#submit">Mark complete</button>
        </div>
      <% else %>
          <div class="community-activity-component__objective-button-container">
            <%= render ProgressComponent.new do |progress| %>
              <%= render ModalComponent.new(
                title: 'Submit evidence',
                reopen_button_text: reopen_button_text,
                show_corner_decoration: false,
                class_name: 'community-activity-component--modal',
                reopen_button_class: achievement_rejected? ? 'ncce-button--white_black_border green-chevron' : nil
              ) do |component| %>
                <%= component.with_confirmation do %>
                  <%= render ModalComponent.new(
                    title: "Discard submitting evidence?",
                    show_corner_decoration: false,
                    class_name: "confirmation-modal",
                    z_index: 2000,
                  ) do |modal| %>
                    <%= modal.with_header do %>
                      <h1 class="govuk-heading-m">Discard submitting evidence?</h1>

                      <div class="icon-close" data-action="click->modal#maybeToggle"></div>
                    <% end %>
                    <%= modal.with_body do %>
                      <p class="govuk-body-m">You can save as a draft to continue later.</p>
                      <div class="govuk-width-container">
                        <div class="govuk-grid-row">
                          <div class="govuk-grid-column-one-half">
                            <button class="govuk-button ncce-button--pink" data-action="modal#cascade">Exit without saving</button>
                          </div>
                          <div class="govuk-grid-column-one-half">
                            <button class="govuk-button button ncce-button--white" data-action="community-activity-component#saveAsDraft">Save as draft</button>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  <% end%>
                <% end %>

                <% component.with_header do %>
                  <h1 class="govuk-heading-m">Submit evidence</h1>

                  <%= progress.with_counter %>
                  <div class="icon-close" data-action="click->modal#maybeToggle"></div>
                <% end %>
                <% component.with_body do %>
                    <h3 class="govuk-heading-s"><%= @activity.title %></h3>

                    <% evidence = @activity.public_copy_evidence.presence || [{ brief: t(".evidence")}] %>
                    <% @activity.public_copy_evidence.each_with_index do |evidence, index| %>
                      <%= progress.with_step do %>
                        <p class="govuk-body-s">
                          <%= evidence["brief"] %>
                          <% if evidence["bullets"].present? %>
                            <ul class="govuk-list govuk-list--bullet">
                              <% evidence["bullets"].each do |bullet| %>
                                <li class="govuk-body-s"><%= bullet %></li>
                              <% end %>
                            </ul>
                          <% end %>
                          <textarea class="govuk-textarea" placeholder="Please provide us with evidence of delivery." data-community-activity-component-target="textarea"><%= @achievement&.evidence&.[](index) %></textarea>
                        </p>
                      <% end %>
                    <% end %>

                    <div class="community-activity-component__footer-actions">
                      <%= progress.with_back do %>
                        Back
                      <% end %>
                      <%= progress.with_continue do %>
                        Continue
                      <% end %>

                      <%= render ModalComponent.new(
                        title: "Are you sure you want to submit this evidence?",
                        show_corner_decoration: false,
                        class_name: "confirmation-modal",
                        show_corner_decoration: false,
                        z_index: 3000
                      ) do |modal| %>
                        <%= modal.with_reopen_button do %>
                          <%= progress.with_submit do %>
                            <button class="govuk-button button ncce-modal--reopen" data-action="modal#toggle">Submit</button>
                          <% end %>
                        <% end %>

                        <%= modal.with_body do %>
                          <p class="govuk-body-m">You will not be able to change or add to this evidence once submitted.</p>
                          <button class="govuk-button button ncce-button--white" data-action="modal#toggle">Continue editing</button>
                          <button class="govuk-button button" data-action="community-activity-component#submit">Submit evidence</button>
                        <% end %>
                      <% end %>
                    </div>
                <% end %>
              <% end %>
            <% end %>
          </div>
      <% end %>
    </span>
    <% if @activity.description.present? %>
      <div class="community-activity-component__description light-blue-bg"><%= @activity.description.html_safe %></div>
    <% end %>
  </div>

</div>
